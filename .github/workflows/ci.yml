name: Frontend CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: frontend-angular/package-lock.json

    - name: Build and test frontend
      working-directory: frontend-angular
      run: |
        npm ci
        npm run test -- --watch=false --browsers=ChromeHeadless
        npm run build

  docker-build:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build frontend image
      uses: docker/build-push-action@v5
      with:
        context: ./frontend-angular
        file: ./frontend-angular/Dockerfile
        push: false
        tags: finsight-frontend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build backend image
      uses: docker/build-push-action@v5
      with:
        context: ./backend-springboot
        file: ./backend-springboot/Dockerfile
        push: false
        load: true
        tags: finsight-backend:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Test docker-compose with H2 database
      run: |
        docker compose -f docker-compose.ci.yml up -d --build
        echo "Waiting for backend to start..."
        sleep 30
        echo "Checking container status..."
        docker compose -f docker-compose.ci.yml ps
        echo "Backend logs:"
        docker compose -f docker-compose.ci.yml logs backend | tail -50
        echo "Waiting for health check..."
        for i in {1..12}; do
          if curl -f http://localhost:8081/actuator/health 2>/dev/null; then
            echo "Backend is healthy!"
            break
          fi
          echo "Attempt $i: Backend not ready yet, waiting 10 seconds..."
          sleep 10
        done
        # Final health check
        curl -f http://localhost:8081/actuator/health || (docker compose -f docker-compose.ci.yml logs backend && exit 1)
        docker compose -f docker-compose.ci.yml down
