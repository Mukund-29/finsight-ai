<div class="user-management-container">
  <!-- Loading Overlay -->
  @if (isLoading || isUpdating || isDeleting || isTogglingActive) {
    <div class="loading-overlay">
      <div class="loading-content">
        <div class="spinner"></div>
        @if (isUpdating) {
          <p>Updating user...</p>
        } @else if (isDeleting) {
          <p>Deleting user...</p>
        } @else if (isTogglingActive) {
          <p>Updating user status...</p>
        } @else {
          <p>Loading...</p>
        }
        <p class="loading-subtitle">Please wait, do not click again</p>
      </div>
    </div>
  }

  <!-- Header -->
  <div class="header">
    <button class="btn-back" (click)="goBack()" [disabled]="isLoading || isUpdating">‚Üê Back</button>
    <h1>User Management</h1>
      <button class="btn-refresh" (click)="loadUsers()" [disabled]="isLoadingUsers || isLoading || isDeleting || isTogglingActive">
        <span class="icon">üîÑ</span> Refresh
      </button>
  </div>

  <!-- Error Message -->
  @if (errorMessage) {
    <div class="error-banner">
      {{ errorMessage }}
    </div>
  }

  <!-- Success Message -->
  @if (successMessage) {
    <div class="success-banner">
      {{ successMessage }}
    </div>
  }

  <!-- Users Table -->
  <div class="users-table-container">
    @if (isLoadingUsers) {
      <div class="loading-container">
        <div class="spinner"></div>
        <p>Loading users...</p>
      </div>
    } @else if (users.length === 0) {
      <div class="empty-state">
        <p>No users found</p>
      </div>
    } @else {
      <table class="users-table">
        <thead>
          <tr>
            <th>NTID</th>
            <th>Email</th>
            <th>Role</th>
            <th>Account</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (user of users; track user.ntid) {
            <tr [class.inactive]="!user.active">
              <td>{{ user.ntid }}</td>
              <td>{{ user.email }}</td>
              <td>
                <span class="role-badge" [ngClass]="'role-' + user.role.toLowerCase()">
                  {{ getRoleLabel(user.role) }}
                </span>
              </td>
              <td>{{ user.account || 'N/A' }}</td>
              <td>
                <div class="status-switch-container">
                  @if (user.ntid.toLowerCase() !== this.user?.ntid?.toLowerCase()) {
                    <label class="switch">
                      <input 
                        type="checkbox" 
                        [checked]="user.active"
                        (change)="toggleUserActive(user, $event)"
                        [disabled]="isLoading || isUpdating || isDeleting || (isTogglingActive && togglingUserId === user.ntid)"
                      />
                      <span class="slider" [ngClass]="{'loading': isTogglingActive && togglingUserId === user.ntid}"></span>
                    </label>
                  } @else {
                    <span class="status-badge" [ngClass]="user.active ? 'status-active' : 'status-inactive'">
                      {{ user.active ? 'Active' : 'Inactive' }}
                    </span>
                  }
                </div>
              </td>
              <td>
                <div class="action-buttons">
                  <button class="btn-edit" (click)="openEditModal(user)" [disabled]="isLoading || isUpdating || isDeleting || isTogglingActive">
                    Edit
                  </button>
                  @if (canDeleteUser(user)) {
                    <button 
                      class="btn-delete" 
                      (click)="deleteUser(user)" 
                      [disabled]="isLoading || isUpdating || isDeleting || isTogglingActive || (isDeleting && deletingUserId === user.ntid)">
                      <span class="btn-content">
                        @if (isDeleting && deletingUserId === user.ntid) {
                          <span class="btn-spinner"></span>
                        }
                        <span>Delete</span>
                      </span>
                    </button>
                  }
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    }
  </div>

  <!-- Edit User Modal -->
  @if (showEditModal && selectedUser) {
    <div class="modal-overlay" (click)="closeEditModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Edit User: {{ selectedUser.ntid }}</h2>
          <button class="btn-close" (click)="closeEditModal()" [disabled]="isUpdating">‚úï</button>
        </div>

        <div class="modal-body">
          <form (ngSubmit)="updateUser()">
            <div class="form-group">
              <label for="ntid">NTID <span class="required">*</span></label>
              <input
                type="text"
                id="ntid"
                name="ntid"
                [(ngModel)]="editForm.ntid"
                required
                [disabled]="isUpdating"
              />
              <small class="form-hint">Note: Changing NTID will update the user's login ID</small>
            </div>

            <div class="form-group">
              <label for="email">Email <span class="required">*</span></label>
              <input
                type="email"
                id="email"
                name="email"
                [(ngModel)]="editForm.email"
                required
                [disabled]="isUpdating"
              />
            </div>

            <div class="form-group">
              <label for="account">Account <span class="required">*</span></label>
              <select
                id="account"
                name="account"
                [(ngModel)]="editForm.account"
                (ngModelChange)="onAccountChange()"
                required
                [disabled]="isLoadingAccounts || isUpdating"
              >
                <option value="">Select account</option>
                @if (isLoadingAccounts) {
                  <option disabled>Loading accounts...</option>
                } @else {
                  @for (account of accounts; track account.accountId) {
                    <option [value]="account.accountName">{{ account.accountName }}</option>
                  }
                }
              </select>
            </div>

            <div class="form-group">
              <label for="role">Role <span class="required">*</span></label>
              <select
                id="role"
                name="role"
                [(ngModel)]="editForm.role"
                required
                [disabled]="isUpdating || (user.role !== 'ADMIN')"
              >
                @for (role of roles; track role.value) {
                  <option [value]="role.value">{{ role.label }}</option>
                }
              </select>
              @if (user.role !== 'ADMIN') {
                <small class="form-hint">Only ADMIN can change user roles</small>
              }
            </div>

            <div class="form-note">
              <p><strong>Note:</strong> Password cannot be changed from this screen. Users must reset their password through the login page.</p>
            </div>

            @if (errorMessage) {
              <div class="error-message">{{ errorMessage }}</div>
            }

            @if (successMessage) {
              <div class="success-message">{{ successMessage }}</div>
            }

            <div class="modal-footer">
              <button type="button" class="btn-cancel" (click)="closeEditModal()" [disabled]="isUpdating">
                Cancel
              </button>
              <button type="submit" class="btn-submit" [disabled]="isUpdating || isLoadingAccounts">
                <span class="btn-content">
                  @if (isUpdating) {
                    <span class="btn-spinner"></span>
                  }
                  <span>Update User</span>
                </span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  }
</div>
