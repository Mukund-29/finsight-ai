<div class="request-detail-container">
  <!-- Global Loading Overlay -->
  @if (isLoading) {
    <div class="loading-overlay">
      <div class="loading-content">
        <div class="spinner"></div>
        @if (isAssigning) {
          <p>Assigning ticket...</p>
        } @else if (isUpdatingStatus) {
          <p>Updating status...</p>
        } @else if (isUpdatingEta) {
          <p>Updating ETA...</p>
        } @else if (isAddingComment) {
          <p>Adding comment...</p>
        } @else if (isDeleting) {
          <p>Deleting request...</p>
        } @else {
          <p>Processing...</p>
        }
        <p class="loading-subtitle">Please wait, do not click again</p>
      </div>
    </div>
  }
  
  @if (isLoading && !request) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Loading request details...</p>
    </div>
  } @else if (errorMessage && !request) {
    <div class="error-container">
      <div class="error-message">{{ errorMessage }}</div>
      <button class="btn-back" (click)="goBack()">Go Back to Dashboard</button>
    </div>
  } @else if (request) {
    <div class="detail-header">
      <button class="btn-back" (click)="goBack()" [disabled]="isLoading || isAssigning || isUpdatingStatus || isDeleting || isUpdatingEta">← Back</button>
      <div class="header-actions">
        @if (canAssignRequest()) {
          <button class="btn-assign" (click)="showAssignForm()" [disabled]="isLoading || isAssigning || isUpdatingStatus || isDeleting">
            <span class="btn-content">
              @if (isAssigning) {
                <span class="btn-spinner"></span>
              }
              <span>Assign Ticket</span>
            </span>
          </button>
        }
        @if (canUpdateStatus()) {
          <button class="btn-update-status" (click)="showStatusUpdateForm()" [disabled]="isLoading || isAssigning || isUpdatingStatus || isDeleting">
            <span class="btn-content">
              @if (isUpdatingStatus) {
                <span class="btn-spinner"></span>
              }
              <span>Update Status</span>
            </span>
          </button>
        }
        @if (canDeleteRequest()) {
          <button class="btn-delete" (click)="deleteRequest()" [disabled]="isLoading || isDeleting">
            <span class="btn-content">
              @if (isDeleting) {
                <span class="btn-spinner"></span>
              }
              <span>Delete Request</span>
            </span>
          </button>
        }
      </div>
    </div>

    <div class="request-detail-card">
      <div class="card-header">
        <div class="header-left">
          <span class="request-id">#{{ request.requestId }}</span>
          <h1>{{ request.title }}</h1>
        </div>
        <div class="header-right">
          <span class="priority-badge" [ngClass]="getPriorityClass(request.priority)">
            {{ request.priority }}
          </span>
          <span class="status-badge" [ngClass]="getStatusClass(request.status)">
            {{ request.status }}
          </span>
        </div>
      </div>

      <div class="card-body">
        <div class="detail-section">
          <h3>Description</h3>
          <p class="description">{{ request.description || 'No description provided' }}</p>
        </div>

        <div class="detail-grid">
          <div class="detail-item">
            <label>Request Type</label>
            <span>{{ request.requestType }}</span>
          </div>
          <div class="detail-item">
            <label>Priority</label>
            <span class="priority-badge" [ngClass]="getPriorityClass(request.priority)">
              {{ request.priority }}
            </span>
          </div>
          <div class="detail-item">
            <label>Status</label>
            <span class="status-badge" [ngClass]="getStatusClass(request.status)">
              {{ request.status }}
            </span>
          </div>
          <div class="detail-item">
            <label>Created By</label>
            <span>{{ request.createdBy }}</span>
          </div>
          <div class="detail-item assigned-to-item">
            <label>Assigned To</label>
            @if (request.assignedTo) {
              <span class="assigned-user">{{ request.assignedTo }}</span>
            } @else {
              <span class="not-assigned">Not assigned</span>
            }
          </div>
          @if (request.assignedBy) {
            <div class="detail-item">
              <label>Assigned By</label>
              <span class="assigned-by">{{ request.assignedBy }}</span>
            </div>
          }
          <div class="detail-item">
            <label>Created At</label>
            <span>{{ request.createdAt | date:'medium' }}</span>
          </div>
          @if (request.assignedAt) {
            <div class="detail-item">
              <label>Assigned At</label>
              <span>{{ request.assignedAt | date:'medium' }}</span>
            </div>
          }
          <div class="detail-item">
            <label>ETA</label>
            @if (request.eta) {
              <div class="eta-display-section">
                <span [ngClass]="{'eta-exceeded': request.etaExceeded, 'eta-approaching': request.etaApproaching}">
                  {{ request.eta | date:'medium' }}
                  @if (request.etaExceeded) {
                    <span class="eta-warning">⚠️ Exceeded</span>
                  } @else if (request.etaApproaching) {
                    <span class="eta-warning">⏰ Approaching</span>
                  }
                </span>
                @if (canUpdateEta()) {
                  <button type="button" class="btn-edit-eta-small" (click)="showEtaUpdate()" [disabled]="isLoading || isAssigning || isUpdatingStatus || isDeleting || isUpdatingEta">
                    Edit ETA
                  </button>
                }
              </div>
            } @else {
              <span class="not-assigned">Not set</span>
            }
          </div>
        </div>

        <div class="timer-section">
          <h3>Time Tracking</h3>
          <div class="timer-grid">
            @if (request.timeInOpenQueue) {
              <div class="timer-item">
                <label>Time in Open Queue</label>
                <span>{{ request.timeInOpenQueue }}</span>
              </div>
            }
            @if (request.timeInDeveloperQueue) {
              <div class="timer-item">
                <label>Time in Developer Queue</label>
                <span>{{ request.timeInDeveloperQueue }}</span>
              </div>
            }
            @if (request.timeUntilEta) {
              <div class="timer-item">
                <label>Time Until ETA</label>
                <span [ngClass]="{'eta-exceeded': request.etaExceeded, 'eta-approaching': request.etaApproaching}">
                  {{ request.timeUntilEta }}
                </span>
              </div>
            }
          </div>
        </div>

        <!-- Comments Section -->
        <div class="comments-section">
          <div class="comments-header">
            <h3>Comments</h3>
            @if (canAddComment()) {
              <button class="btn-add-comment" (click)="showAddComment()" [disabled]="isLoading || isAddingComment">
                <span class="btn-content">
                  @if (isAddingComment) {
                    <span class="btn-spinner"></span>
                  }
                  <span>+ Add Comment</span>
                </span>
              </button>
            }
          </div>

          @if (isLoadingComments) {
            <div class="comments-loading">
              <div class="spinner-small"></div>
              <p>Loading comments...</p>
            </div>
          } @else if (comments.length === 0) {
            <div class="comments-empty">
              <p>No comments yet. Be the first to comment!</p>
            </div>
          } @else {
            <div class="comments-list">
              @for (comment of comments; track comment.commentId) {
                <div class="comment-item" [ngClass]="{'eta-change-comment': comment.isEtaChange}">
                  <div class="comment-header">
                    <span class="comment-author">{{ comment.commentedBy }}</span>
                    <span class="comment-date">{{ comment.commentedAt | date:'medium' }}</span>
                    @if (comment.isEtaChange) {
                      <span class="eta-change-badge">ETA Change</span>
                    }
                  </div>
                  <div class="comment-body">
                    <p class="comment-text">{{ comment.commentText }}</p>
                    @if (comment.isEtaChange && (comment.oldEta || comment.newEta)) {
                      <div class="eta-change-details">
                        @if (comment.oldEta && comment.newEta) {
                          <p class="eta-change-info">
                            <strong>ETA Changed:</strong> 
                            <span class="old-eta">{{ comment.oldEta | date:'medium' }}</span> 
                            → 
                            <span class="new-eta">{{ comment.newEta | date:'medium' }}</span>
                          </p>
                        } @else if (comment.newEta) {
                          <p class="eta-change-info">
                            <strong>ETA Set:</strong> 
                            <span class="new-eta">{{ comment.newEta | date:'medium' }}</span>
                          </p>
                        }
                        @if (comment.changeReason) {
                          <p class="change-reason"><strong>Reason:</strong> {{ comment.changeReason }}</p>
                        }
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          }

          <!-- Add Comment Form -->
          @if (showAddCommentForm) {
            <div class="add-comment-form" #commentForm>
              <div class="form-group">
                <label for="newComment">Add Comment</label>
                <textarea
                  id="newComment"
                  name="newComment"
                  [(ngModel)]="newComment.commentText"
                  placeholder="Enter your comment here..."
                  rows="4"
                  [disabled]="isAddingComment"
                ></textarea>
              </div>
              @if (errorMessage) {
                <div class="error-message">{{ errorMessage }}</div>
              }
              <div class="form-actions">
                <button class="btn-cancel" (click)="cancelAddComment()" [disabled]="isAddingComment">Cancel</button>
                <button class="btn-submit" (click)="addComment()" [disabled]="isAddingComment || !newComment.commentText || newComment.commentText.trim() === ''">
                  <span class="btn-content">
                    @if (isAddingComment) {
                      <span class="btn-spinner"></span>
                    }
                    <span>Add Comment</span>
                  </span>
                </button>
              </div>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Assignment Modal -->
    @if (showAssignModal) {
      <div class="modal-overlay" (click)="showAssignModal = false">
        <div class="modal-content" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2>Assign Ticket</h2>
            <button class="btn-close" (click)="showAssignModal = false">✕</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="assignedTo">Assign To <span class="required">*</span></label>
              <select
                id="assignedTo"
                name="assignedTo"
                [(ngModel)]="assignmentData.assignedTo"
                required
                [disabled]="isLoadingUsers"
              >
                <option value="">Select a user</option>
                @if (isLoadingUsers) {
                  <option disabled>Loading users...</option>
                } @else {
                  @for (user of assignableUsers; track user.ntid) {
                    <option [value]="user.ntid">
                      {{ user.ntid }} ({{ user.role }}) - {{ user.email }}
                    </option>
                  }
                }
              </select>
            </div>
            <div class="form-group">
              <label for="eta">ETA <span class="required">*</span></label>
              @if (!showEtaPicker && assignmentData.eta) {
                <div class="eta-display">
                  <span>{{ assignmentData.eta | date:'medium' }}</span>
                  <button type="button" class="btn-edit-eta" (click)="showEtaPicker = true">Edit</button>
                </div>
              } @else {
                <div class="eta-picker">
                  <div class="eta-inputs">
                    <div class="eta-input-group">
                      <label for="etaDate">Date</label>
                      <input
                        type="date"
                        id="etaDate"
                        name="etaDate"
                        [(ngModel)]="assignmentData.etaDate"
                        [min]="getMinDate()"
                        required
                      />
                    </div>
                    <div class="eta-input-group">
                      <label for="etaTime">Time</label>
                      <input
                        type="time"
                        id="etaTime"
                        name="etaTime"
                        [(ngModel)]="assignmentData.etaTime"
                        required
                      />
                    </div>
                  </div>
                  <button type="button" class="btn-done" (click)="setEta()" [disabled]="!assignmentData.etaDate || !assignmentData.etaTime">
                    Done
                  </button>
                </div>
              }
            </div>
            @if (errorMessage) {
              <div class="error-message">{{ errorMessage }}</div>
            }
          </div>
          <div class="modal-footer">
            <button class="btn-cancel" (click)="showAssignModal = false" [disabled]="isAssigning">Cancel</button>
            <button class="btn-submit" (click)="assignRequest()" [disabled]="isAssigning || isLoadingUsers">
              <span class="btn-content">
                @if (isAssigning) {
                  <span class="btn-spinner"></span>
                }
                <span>Assign Ticket</span>
              </span>
            </button>
          </div>
        </div>
      </div>
    }

    <!-- Status Update Modal -->
    @if (showStatusUpdate) {
      <div class="modal-overlay" (click)="showStatusUpdate = false">
        <div class="modal-content" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2>Update Status</h2>
            <button class="btn-close" (click)="showStatusUpdate = false">✕</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="status">New Status <span class="required">*</span></label>
              <select
                id="status"
                name="status"
                [(ngModel)]="statusUpdate.status"
                required
              >
                <option value="">Select status</option>
                @for (status of availableStatuses; track status.value) {
                  <option [value]="status.value">{{ status.label }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label for="comment">Comment</label>
              <textarea
                id="comment"
                name="comment"
                [(ngModel)]="statusUpdate.comment"
                placeholder="Add a comment (optional)"
                rows="4"
              ></textarea>
            </div>
            @if (errorMessage) {
              <div class="error-message">{{ errorMessage }}</div>
            }
          </div>
          <div class="modal-footer">
            <button class="btn-cancel" (click)="showStatusUpdate = false" [disabled]="isUpdatingStatus">Cancel</button>
            <button class="btn-submit" (click)="updateStatus()" [disabled]="isUpdatingStatus">
              <span class="btn-content">
                @if (isUpdatingStatus) {
                  <span class="btn-spinner"></span>
                }
                <span>Update Status</span>
              </span>
            </button>
          </div>
        </div>
      </div>
    }

    <!-- ETA Update Modal -->
    @if (showEtaUpdateForm) {
      <div class="modal-overlay" (click)="cancelEtaUpdate()">
        <div class="modal-content" (click)="$event.stopPropagation()">
          <div class="modal-header">
            <h2>Update ETA</h2>
            <button class="btn-close" (click)="cancelEtaUpdate()" [disabled]="isUpdatingEta">✕</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="etaDate">New ETA Date <span class="required">*</span></label>
              <input
                type="date"
                id="etaDate"
                name="etaDate"
                [(ngModel)]="etaUpdateData.etaDate"
                [min]="getMinDate()"
                required
                [disabled]="isUpdatingEta"
              />
            </div>
            <div class="form-group">
              <label for="etaTime">New ETA Time <span class="required">*</span></label>
              <input
                type="time"
                id="etaTime"
                name="etaTime"
                [(ngModel)]="etaUpdateData.etaTime"
                required
                [disabled]="isUpdatingEta"
              />
            </div>
            <div class="form-group">
              <label for="changeReason">Reason for ETA Change <span class="required">*</span></label>
              <textarea
                id="changeReason"
                name="changeReason"
                [(ngModel)]="etaUpdateData.changeReason"
                placeholder="Please provide a reason for changing the ETA (required)"
                rows="3"
                required
                [disabled]="isUpdatingEta"
              ></textarea>
              <small class="form-hint">This field is mandatory when updating ETA</small>
            </div>
            <div class="form-group">
              <label for="commentText">Additional Comment (Optional)</label>
              <textarea
                id="commentText"
                name="commentText"
                [(ngModel)]="etaUpdateData.commentText"
                placeholder="Add any additional comments (optional)"
                rows="3"
                [disabled]="isUpdatingEta"
              ></textarea>
            </div>
            @if (errorMessage) {
              <div class="error-message">{{ errorMessage }}</div>
            }
          </div>
          <div class="modal-footer">
            <button class="btn-cancel" (click)="cancelEtaUpdate()" [disabled]="isUpdatingEta">Cancel</button>
            <button class="btn-submit" (click)="updateEta()" [disabled]="isUpdatingEta || !etaUpdateData.etaDate || !etaUpdateData.etaTime || !etaUpdateData.changeReason || etaUpdateData.changeReason.trim() === ''">
              <span class="btn-content">
                @if (isUpdatingEta) {
                  <span class="btn-spinner"></span>
                }
                <span>Update ETA</span>
              </span>
            </button>
          </div>
        </div>
      </div>
    }
  }
</div>
